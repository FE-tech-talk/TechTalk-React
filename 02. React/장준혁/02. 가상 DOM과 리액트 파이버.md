## 2. 가상 DOM과 리액트 파이버

### DOM과 브라우저 렌더링 과정

1. 브라우저가 사용자가 요청한 주소를 방문하여 HTML 파일 다운로드
2. 브라우저의 렌더링 엔진이 HTML을 파싱하여 DOM 노드로 구성된 DOM트리 생성
3. 2번 과정에서 CSS파일을 만나면 CSS파일도 다운로드
4. 브라우저의 렌더링 엔진이 CSS를 파싱하여 CSS 노드로 구성된 CSSOM트리 생성
5. 브라우저가 2번에서 만든 DOM 노드를 순회하여 눈에 보이는 노드 (ex. display: none제외) 순회
6. 눈에 보이는 노드들에 대한 CSSOM 정보를 찾고 스타일 적용
   - layout: 브라우저 화면의 어느 좌표에 나타나야 하는지 계산하는 과정. 반드시 페인트 과정도 거친다
   - painting: 레이아웃 단계를 거친 노드와 실제 유효한 모습을 그리는 과정

### 가상 DOM 탄생 배경

대다수 앱은 사용자의 인터랙션을 통해 다양한 변경사항이 일어난다.
색상이 변경 된 경우 페인팅만 일어나므로 빠르게 처리할 수 있으나 요소의 위치나 크기가 바뀔 경우 레이아웃이 일어나고 리페인팅이 일어나게 되어 많은 비용이 든다.
특히, SPA에서 이러한 과정이 자주 일어나는데 DOM을 관리하는 과정에서 부담해야 할 비용이 커진다.
개발자 입장에서는 DOM의 변경 사항보다 결과물 하나만 알고 싶을 것이므로 가상 DOM이 나타났다.
가상 DOM은 브라우저가 아닌 리액트가 관리하며 웹페이지가 표시해야 할 DOM을 메모리에 저장하고 리액트가 변경에 준비가 되었을 때 실제 브라우저의 DOM에 반영한다.
메모리에서 계산하는 과정을 거쳐 여러번 발생할 렌더링 과정을 최소화하고 브라우저와 개발자의 부담을 줄인다.
가상 DOM은 일반 브라우저의 DOM보단 항상 빠르진 않고 렌더링 방식에 있어서 브라우저와 개발자에게 도움을 주기 위해 만들었다.

### 가상 DOM을 위한 아키텍처, 리액트 파이버

1. 리액트 파이버란?

리액트 파이버는 리액트가 관리하는 자바스크립트 객체로, fiber reconciler(파이버 재조정자)가 관리하는데 실제 DOM과 가상 DOM을 비교해 변경사항을 수집하고 차이가 있으면 변경에 관련된 정보를 가진 파이버를 기준으로 화면에 렌더링을 요청한다. 즉, reconciliation(재조정)은 가상 DOM과 실제 DOM을 비교하는 알고리즘이다.

리액트 파이버는 애니메이션, 레이아웃, 인터랙션에 올바른 결과물을 만드는 반응성 문제를 해결하는 것이 목표이며 비동기로 작업을 작은 단위로 나누어 우선순위를 매기거나, 작업을 일시중지하여 나중에 다시 시작하거나, 이전에 했던 작업을 다시 재사용 혹은 폐기할 수 있다.

과거 리액트는 스택 알고리즘이였으나 동기식 처리로 인한 지연으로 파이버가 만들어졌다.
파이버는 하나의 작업 단위로 구성되어있고 finishedWork()라는 작업으로 마무리한다.
그리고 작업을 커밋하여 실제 브라우저 DOM에 변경사항을 만들어낸다.
이 단계는 두 단계로 나눌 수 있는데 렌더 단계에서 사용자에게 노출되지 않는 모든 비동기 작업을 수행하고 이 단계에서 파이버 작업인 우선순위를 정하거나 중지시키거나 버린다.
두번째 단계로 DOM에 실제 변경사항을 반영하기 위한 작업인 commitWork()로 커밋된다. 이 때는 동기식으로 일어나고 중단될 수도 없다.

파이버 관련 주요 속성

- tag: 1:1로 매칭된 정보를 지닌다. (ex. 컴포넌트, DOM 노드, 등)
- stateNode: 파이버 자체에 대한 참조 정보
- child, sibling, return: 파이버 간 관계, return은 부모
- index: sibling에서 자신의 위치가 몇번째 인지 숫자로 표현
- pendingProps: 작업을 처리하지 못한 props
- memoizedProps: pendingProps를 기준으로 렌더링 완료 후 memoizedProps로 저장
- updateQueue: 상태 업데이트, 콜백 함수, DOM 업데이트 등 작업을 담는 큐
- memoizedState: 함수 컴포넌트 훅 목록
- alternate: 반대편 트리 파이버

2. 리액트 파이버 트리

파이버 트리는 리액트에서 두 개가 존재하는데 하나는 현재의, 다른 하나는 작업 중인 상태를 나타내는 workInProgress트리가 있다. 파이버의 작업이 끝나면 단순히 포인터만 변경하여 workInProgress 트리를 현재 트리로 바꿔준다. (이러한 기술을 더블 버퍼링이라고 한다, 더블 버퍼링은 사용자에게 처리하지 못한 모습을 발생하는 것을 방지하기 위해 다음으로 그려야 할 그림을 미리 그려 현재 상태로 바꾸는 기법이다.)

UI 렌더링을 위해 current를 기준으로 업데이트가 발생하면 workInProgress 트리를 빌드하고 빌드가 끝나면 다음 렌더링에 이 트리를 사용한다. workInProgress가 끝나면 current로 변경된다.

3. 파이버의 작업 순서
   1. beginWork()를 실행하여 자식이 없는 파이버를 만날 때까지 트리 형식으로 시작
   2. completeWork()를 실행해 파이버 작업 완료
   3. 형제가 있다면 형제로
   4. 2, 3이 끝나면 return으로 돌아가 완료

여기서 setState 등으로 인한 업데이트가 발생하면 workInProgress 트리를 다시 빌드시켜 기존 파이버에서 업데이트 된 props를 받아 파이버 내부에서 처리.

### 파이버와 가상 DOM

리액트 컴포넌트에 대한 정보를 1:1로 가지고 있는 것이 파이버, 리액트 내부에서 비동기로 이루어진다.
실제 브라우저 DOM에 반영하는 것은 동기적으로 일어나야하므로 메모리상에서 먼저 수행해 최종 결과물만 실제브라우저 DOM에 적용한다.

가상 DOM은 웹 애플리케이션에서 통용되는 개념이고 파이버는 네이티브같은 환경에서도 사용할 수 있어 동일한 개념은 아니지만 렌더러가 다르더라도 파이버를 통해 조정되는 과정을 동일하여 동일한 reconciler(재조정자)를 사용할 수 있다.
